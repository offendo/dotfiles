#+TITLE: Nilay's Emacs Configuration
#+AUTHOR: Nilay
#+DESCRIPTION: Trying out a non-doom configuration
#+STARTUP: content
#+PROPERTY: header-args :results silent
#+ROAM_TAGS: config nilay

* Global Packages
** Use-package 
#+begin_src elisp
(straight-use-package 'use-package) 
#+end_src

** General
Check out the [[https://github.com/noctuid/general.el][general]] page for more information.
#+begin_src elisp
(use-package general
  :straight t
  :config
  (general-evil-setup t))
#+end_src

** Evil Mode
*** Evil
#+begin_src elisp
(use-package evil
  :init
  (setq evil-want-keybinding nil)
  (setq evil-want-integration t)
  (setq evil-want-Y-yank-to-eol t) ;; Y yanks foward
  :straight t
  :config
  (evil-mode 1)
  (if (display-graphic-p)
    (define-key key-translation-map (kbd "ESC") (kbd "C-g")))
  :general
  (:keymaps 'evil-motion-state-map "RET" nil))
#+end_src

*** Collection
#+begin_src elisp
(use-package evil-collection ;; make evil available everywhere
    :after evil
    :straight t
    :init (evil-collection-init))
#+end_src

*** Undo-fu
#+begin_src elisp
(use-package undo-fu ;; make undo system work better
    :after evil
    :straight t
    :config
    (evil-set-undo-system 'undo-fu)
    (setq evil-want-fine-undo t))
#+end_src

*** Goggles
#+begin_src elisp
(use-package evil-goggles ;; show what I'm editing in a flash
    :after evil
    :straight t
    :config
    (evil-goggles-mode)
    (setq evil-goggles-pulse t)
    (setq evil-goggles-duration 0.100))
#+end_src

*** Multiple Cursors
#+begin_src elisp
(use-package evil-mc
  :straight t
  :general
  (:states '(normal visual)
   "C-." 'evil-mc-make-and-goto-next-match
   "C-," 'evil-mc-make-and-goto-prev-match
   "C->" 'evil-mc-skip-and-goto-next-match
   "C-<" 'evil-mc-skip-and-goto-prev-match
   "C-S-a" 'evil-mc-make-all-cursors
   "C-g" 'evil-mc-undo-all-cursors
   "C-l" 'evil-mc-make-cursor-in-visual-selection-beg
   "C-/" 'evil-mc-undo-last-added-cursor)
  (:keymaps 'mc/keymap "RET" nil)
  :init (global-evil-mc-mode))
#+end_src

*** Surround
#+begin_src elisp
(use-package evil-surround
  :straight t
  :config
  (global-evil-surround-mode 1))
#+end_src

*** Org-mode stuff
#+begin_src elisp
(use-package evil-org
  :straight t
  :after org
  :hook (org-mode . evil-org-mode)
  :config
  (require 'evil-org-agenda)
  (evil-org-agenda-set-keys))
#+end_src

*** Match-it
#+begin_src elisp
(use-package evil-matchit
  :straight t
  :after evil
  :config (global-evil-matchit-mode 1))
#+end_src

*** Exchange
#+begin_src elisp
(use-package evil-exchange
  :straight t
  :general 
  (:keymaps 'override
   :states '(normal visual)
   "gx" 'evil-exchange
   "gX" 'evil-exchange-cancel))
#+end_src

** Which-key
#+begin_src elisp
(use-package which-key
  :straight t
  :config
  (which-key-mode)
  (setq which-key-idle-delay 0.5))
#+end_src

* Emacs Stuff
** Startup Time
This doesn't work with early-init though, so it'll take some work if I ever want to use it
#+begin_src elisp
;; Startup time
(use-package esup
  :straight t)
#+end_src

** Keybindings
*** General
#+begin_src elisp
(general-create-definer leader-def
  :states '(normal insert emacs)
  :prefix "SPC"
  :keymaps 'override
  :non-normal-prefix "M-SPC"
  :prefix-command 'leader-prefix-command
  :prefix-map 'leader-prefix-map)

(general-create-definer leader-code-def
  :states '(normal insert emacs)
  :prefix "SPC c"
  :keymaps 'override
  :non-normal-prefix "M-SPC c"
  :prefix-command 'code
  :prefix-map 'leader-code-prefix-map)

;; Find-file
(leader-def "." 'find-file)

;; Dired
(defun nilays-open-dired ()
  "Open dired"
  (interactive)
  (dired "."))

(leader-def "-" 'nilays-open-dired)

;; Bookmarks
(leader-def "v" 'bookmark-map)

;; Buffer stuff
(general-create-definer leader-buffer-def
  :states '(normal insert emacs)
  :prefix "SPC b"
  :keymaps 'override
  :non-normal-prefix "M-SPC b"
  :prefix-command 'buffer
  :prefix-map 'leader-buffer-prefix-map)

(leader-buffer-def "i" 'ibuffer)
(leader-buffer-def "d" 'evil-delete-buffer)


;; Org-mode

(general-create-definer leader-org-def
  :states '(normal insert emacs)
  :prefix "SPC o"
  :keymaps 'override
  :non-normal-prefix "M-SPC o"
  :prefix-command 'org-stuff
  :prefix-map 'leader-org-prefix-map)

(general-create-definer leader-org-roam-def
  :states '(normal insert emacs)
  :prefix "SPC o n"
  :keymaps 'org-roam-mode-map
  :non-normal-prefix "M-SPC o n"
  :prefix-command 'org-roam-stuff
  :prefix-map 'leader-org-roam-prefix-map)

(general-create-definer leader-misc-def
  :states '(normal insert emacs)
  :prefix "SPC u"
  :keymaps 'global
  :non-normal-prefix "M-SPC u"
  :prefix-command 'misc-stuff
  :prefix-map 'leader-misc-prefix-map)
#+end_src

*** Custom stuff
#+begin_src elisp
;; Move up directory while searching in find-file
(defun delete-backwards-to-slash ()
  "Deletes text until the previous slash"
  (interactive)
  (delete-region
   (point)
   (save-excursion (evil-find-char-to-backward (if (eq ?/ (char-before)) 2 1) ?/) (point))))

(defun c-backspace-dwim ()
  "Attempts to delete to previous slash. If no slash, deletes previous word."
  (interactive)
  (condition-case nil
      (delete-backwards-to-slash)
    (error (evil-delete-backward-word))))

;; Bind to C-backspace
(general-define-key
 :keymaps 'minibuffer-mode-map
 "C-<backspace>" 'c-backspace-dwim)

#+end_src

** Built-ins
*** Customize
#+begin_src elisp
(setq custom-file "/home/offendo/.dotfiles/.emacs.d/customize.el")
#+end_src

*** Disable compilation warnings
#+begin_src elisp
(setq warning-suppress-log-types '((comp)))
#+end_src

*** Personal info
#+begin_src elisp
(setq user-mail-address "nilaypatel2@gmail.com")
#+end_src

*** Indentation
#+begin_src elisp
;; Expand tab to spaces
(setq indent-tabs-mode nil)
(setq tab-width 2)
#+end_src

*** Caching
#+begin_src elisp
;; cache-directory
(setq nilays-cache-dir (concat user-emacs-directory ".cache/"))
;; save history
(setq savehist-file (concat nilays-cache-dir "savehist"))
(savehist-mode 1)
;; backup files all in one place
(setq backup-directory-alist
        `((".*" . ,nilays-cache-dir)))
(setq auto-save-file-name-transforms
        `((".*" ,nilays-cache-dir t)))
;; remove lock files
(setq create-lockfiles nil)
#+end_src

*** Recentf
#+begin_src elisp
;; recentf-mode
(recentf-mode 1)
(setq recentf-max-menu-items 25)
(setq recentf-max-saved-items 25)
(setq recentf-save-file (concat nilays-cache-dir "recentf" ))
#+end_src

*** Path
#+begin_src elisp
;; add to path
(use-package exec-path-from-shell
  :straight t
  :init (when (daemonp) (exec-path-from-shell-initialize)))
#+end_src

*** Help
#+begin_src elisp
;; select help window on open
(setq help-window-select t)
(add-to-list 'display-buffer-alist
             '((lambda (bufname _) (with-current-buffer bufname (equal major-mode 'help-mode)))
               (display-buffer-reuse-window display-buffer-at-bottom)
               (reusable-frames . visible)
               (window-height . 0.25)))
(setq help-at-pt-display-when-idle t)
(help-at-pt-set-timer)
#+end_src

*** Tramp Mode
#+begin_src elisp
(use-package tramp
  :straight nil
  :config 
  (setq tramp-default-method "ssh"))
#+end_src

*** Scrolling
#+begin_src elisp
(general-nmap "<up>" 'scroll-up-line)
(general-nmap "<down>" 'scroll-down-line)
(setq scroll-step           1
      scroll-conservatively 10000)
#+end_src

*** Find-file
#+begin_src elisp
;; Runs make-directory if we try to find-file a file that doesn't exist
(defadvice find-file (before make-directory-maybe (filename &optional wildcards) activate)
  "Create parent directory if not exists while visiting file."
  (unless (file-exists-p filename)
    (let ((dir (file-name-directory filename)))
      (unless (file-exists-p dir)
        (make-directory dir t)))))
#+end_src

*** Dired
#+begin_src elisp
(setq vc-follow-symlinks t)
(add-hook 'dired-mode-hook
      (lambda ()
        (dired-hide-details-mode)))
#+end_src

** Text Objects
#+begin_src elisp
(defmacro define-and-bind-text-object (key start-regex end-regex)
  (let ((inner-name (make-symbol "inner-name"))
        (outer-name (make-symbol "outer-name")))
    `(progn
       (evil-define-text-object ,inner-name (count &optional beg end type)
         (evil-select-paren ,start-regex ,end-regex beg end type count nil))
       (evil-define-text-object ,outer-name (count &optional beg end type)
         (evil-select-paren ,start-regex ,end-regex beg end type count t))
       (define-key evil-inner-text-objects-map ,key (quote ,inner-name))
       (define-key evil-outer-text-objects-map ,key (quote ,outer-name)))))


;; i$/a$ objects
(define-and-bind-text-object "$" "\\$" "\\$")

;; create "id"/"ad" (inside/around) entire buffer text objects:
(define-and-bind-text-object "d" "\\`\\s-*" "\\s-*\\'")

(defun nilays-end-of-non-whitespace()
  "Move to the last non-whitespace character in the current line."
  (interactive)
  (move-end-of-line nil)
  (re-search-backward "^\\|[^[:space:]]"))                                       

(evil-define-text-object nilays-inner-line (count &optional beg end type)
  "Select a line ignoring starting and ending whitespace"
  (save-excursion
    (evil-first-non-blank)
    (let ((begp (point)))
      (nilays-end-of-non-whitespace)
      (let  ((endp (point)))
        (evil-range begp (+ 1 endp))))))

(general-define-key
 :keymaps 'evil-inner-text-objects-map
 "l" 'nilays-inner-line)
#+end_src

** Emacs Anywhere
#+begin_src elisp
(setq ea-window-title "floating")
#+end_src

* Coding
** Magit
#+begin_src elisp
(use-package magit
  :straight t
  :general
  (leader-def "g" 'magit-status))
#+end_src

** Compilation Mode
#+begin_src elisp
(use-package compile
  :straight nil
  :general
  (leader-code-def "c" 'compile)
  :config (setq compilation-scroll-output t))

(defun colorize-compilation-buffer ()
  (let ((inhibit-read-only t))
    (ansi-color-apply-on-region (point-min) (point-max))))

(use-package ansi-color
  :straight nil
  :init (add-hook 'compilation-filter-hook 'colorize-compilation-buffer))
#+end_src

** Language Settings
*** LaTeX
#+begin_src elisp
(use-package latex
  :straight nil
  :hook (LaTeX-mode . auto-fill-mode)
  :config
  (setq TeX-view-program-list
        '(("qpdfview" ("qpdfview --unique %o" (mode-io-correlate "#src:%b:%n:0")) "qpdfview")))
  (setq tex-fontify-script nil
        font-latex-fontify-script nil
        font-latex-fontify-sectioning 'color)
  (setq +latex-viewers '(qpdfview pdf-tools skim evince sumatrapdf zathura okular))
  (setq TeX-view-program-selection
        '(((output-dvi has-no-display-manager) "dvi2tty")
          ((output-dvi style-pstricks) "dvips and gv")
          (output-dvi "xdvi")
          (output-pdf "qpdfview")
          (output-html "xdg-open")))
  (push '("LatexMk" "latexmk -bibtex -outdir=/tmp %t; cp -v /tmp/%o ." TeX-run-TeX nil t
          :help "Make pdf output using latexmk.")
        TeX-command-list)
  (setq TeX-default-command "LatexMk"
        TeX-command "LatexMk"
        LaTeX-command "LatexMk")
  )
(use-package auctex
  :straight t
  :defer t)
#+end_src

*** Python
**** Python-mode
#+begin_src elisp
(use-package python
  :straight nil
  :mode ("\\.py\\'" . python-mode)
  :interpreter ("python" . python-mode)
  :hook 
    (python-mode . tree-sitter-hl-mode)
  :config 
  (setq python-indent-guess-indent-offset-verbose nil))
#+end_src

**** EIN (jupyter)
#+begin_src elisp
(use-package ein
  :straight t)
#+end_src

**** Pyvenv
#+begin_src elisp
(use-package pyvenv
  :straight t
  :config
  (setenv "WORKON_HOME" "~/.local/share/virtualenvs/")
  (setq pyvenv-mode-line-indicator
        '(pyvenv-virtual-env-name
          ("(Env: " pyvenv-virtual-env-name ") ")))
  (pyvenv-mode t))

;; Tell the function where to look for virtual envs
(defvar venv-directory)
(setq venv-directory "/home/offendo/.local/share/virtualenvs/")

(defun auto-venv-activate ()
  "Automatically activate virtualenv if one is found in `venv-directory`"
  (let ((venvs (seq-filter
                (lambda (dirname)
                  (string-match-p (regexp-quote (projectile-project-name)) dirname))
                (directory-files venv-directory))))
    (if venvs
        (progn (pyvenv-workon (car venvs))
               (message (concat "Activated " (car venvs)))))))
#+end_src

*** Haskell
#+begin_src elisp
(use-package haskell-mode
  :straight t
  :mode "\\.hs\\'")
#+end_src

*** JSON
**** JSON
#+begin_src elisp
(use-package json-mode
  :mode "\\.json\\'"
  :straight t
  :config
  (setq json-reformat:indent-width 2))
#+end_src

**** JSONNet
#+begin_src elisp
(use-package jsonnet-mode
  :straight t)
#+end_src

*** YAML
#+begin_src elisp
(use-package yaml-mode
  :straight t)
#+end_src

*** Docker
#+begin_src elisp
(use-package docker
  :straight t
  :general
  (leader-def "d" 'docker))

(use-package dockerfile-mode
  :straight t)
#+end_src

** LSP
*** LSP mode
#+begin_src elisp
(use-package lsp-mode
  :straight t
  :general
  ;; changes K to use LSP
  (:keymaps '(lsp-mode-map)
        :states 'normal
        "K"  'lsp-describe-thing-at-point)
  :init
  (setq lsp-diagnostics-provider :flycheck))

(use-package lsp-ui
  :straight t
  :commands lsp-ui-mode
  :after lsp-mode
  :hook (lsp-mode . lsp-ui-mode)
  :config
  (setq lsp-ui-doc-max-height 16
        lsp-ui-doc-max-width 100
        lsp-ui-doc-enable nil
        lsp-ui-doc-position 'top
        lsp-ui-sideline-ignore-duplicate t
        lsp-ui-sideline-show-code-actions nil
        lsp-signature-auto-activate t
        lsp-signature-lines 2
        lsp-signature-render-documentation nil
        lsp-enable-symbol-highlighting nil)
  :general
  ;; goto stuff
  (:keymaps '(global lsp-mode-map)
        :states 'normal
        :prefix "g"
        "r" 'lsp-ui-peek-find-references
        "d" 'lsp-find-definition
        "m" 'lsp-ui-imenu
        "D" 'lsp-ui-peek-find-definitions)
  ;; rename
  (leader-code-def "r" 'lsp-rename))
#+end_src

*** Python
#+begin_src elisp
(use-package lsp-python-ms
  :straight t
  :config (setq lsp-python-ms-auto-install-server t
                lsp-python-ms-cache "Library")
  :init (setq-default lsp-python-ms-extra-paths ["/home/offendo/src/the-count/"])
  :hook (python-mode . (lambda ()
                         (auto-venv-activate)
                         (require 'lsp-python-ms)
                         (lsp))))
;; (use-package lsp-jedi
;;   :straight t
;;   :hook (python-mode . (lambda () (require 'lsp-jedi) (lsp)))
;;   :config
;;     (add-to-list 'lsp-disabled-clients 'pyls)
;;     (add-to-list 'lsp-enabled-clients 'jedi))
#+end_src

*** Haskell
#+begin_src elisp
(use-package lsp-haskell
  :straight t
  :hook (haskell-mode . lsp))
#+end_src

** Projectile
#+begin_src elisp
(use-package projectile
  :straight t
  :defer t
  :init
  (setq projectile-cache-file
        (concat nilays-cache-dir ".projectile.cache"))
  (setq projectile-auto-discover nil)
  (projectile-mode +1)
  :general
  (leader-def "p" 'projectile-command-map)
  (:keymaps 'projectile-command-map
        "d" 'projectile-remove-known-project
        "a" 'projectile-add-known-project
        "m" 'consult-project-imenu))
#+end_src

** FlyCheck
#+begin_src elisp
(use-package flycheck
  :straight t
  :hook (prog-mode . flycheck-mode)
  :config
  (setq flycheck-check-syntax-automatically '(save)
        flycheck-disabled-checkers '(python-flake8 python-pyright)))
#+end_src

* Completion
** Complete-read Suite
*** Selectrum
#+begin_src elisp
;; Selectrum
(use-package selectrum
  :straight t
  :config
  (selectrum-mode +1)
  (setq completion-ignore-case t
        read-file-name-completion-ignore-case t
        read-buffer-completion-ignore-case t))
#+end_src

*** Prescient
#+begin_src elisp
;; Prescient
(use-package prescient
  :straight t
  :after selectrum)
(use-package selectrum-prescient
  :straight t
  :after '(selectrum prescient)
  :config
  (selectrum-prescient-mode)
  (setq selectrum-prescient-enable-sorting t)
  (setq selectrum-prescient-enable-filtering t)
  (prescient-persist-mode))
#+end_src

*** Orderless
#+begin_src elisp
(use-package orderless
  :straight t
  :defer t
  :custom (completion-styles '(orderless substring )))
#+end_src

*** Consult
#+begin_src elisp
(use-package consult
  :straight t
  :after selectrum
  :config
  (setq xref-show-xrefs-function 'consult-xref
        xref-show-definitions-function 'consult-xref)
  :general
  (leader-def "," 'consult-buffer)
  (leader-def "y" 'consult-register)
  (leader-def "m" 'consult-imenu)
  (leader-def "f" 'consult-ripgrep))
#+end_src

*** Marginalia
#+begin_src elisp
(use-package marginalia
  :straight t
  :after selectrum
  :general
  (:keymaps 'minibuffer-local-map
            "M-A"  'marginalia-cycle)
  :init
  (marginalia-mode)
  (advice-add
   #'marginalia-cycle
   :after (lambda ()
            (when (bound-and-true-p selectrum-mode)
              (selectrum-exhibit 'keep-selected)))))
#+end_src

*** Embark 
#+begin_src elisp
(use-package embark
  :straight t
  :after selectrum
  :general
  ("C-b" 'embark-act)
  (:keymaps 'embark-file-map
  "d" 'delete-file
  "r" 'rename-file
  "c" 'copy-file
  "v" 'find-file-other-window))

(use-package embark-consult
  :straight t
  :after '(embark consult)
  :demand t
  :hook
  (embark-collect-mode . embark-consult-preview-minor-mode))
#+end_src

** Company
#+begin_src elisp
(use-package company
  :straight t
  :general 
  (:keymaps 'company-mode-map 
   "C-l" 'company-complete)
  (:keymaps 'company-mode-map
   :states '(insert)
   "C-n" 'company-select-next
   "C-p" 'company-select-previous
   "C-f" 'company-files)
  :config
  (setq company-idle-delay 0.2 
        company-show-numbers t 
        company-tooltip-limit 10 
        company-minimum-prefix-length 2 
        company-tooltip-align-annotations t
        ;; invert the navigation direction if the the completion popup-isearch-match
        ;; is displayed on top (happens near the bottom of windows)
        company-tooltip-flip-when-above t)
  (global-company-mode 1))
#+end_src

* Viewing
** Vterm
#+begin_src elisp
(use-package vterm
  :defer t
  :straight t)
(use-package vterm-toggle
  :straight t
  :init
  (setq vterm-toggle-fullscreen-p nil)
  (add-to-list 'display-buffer-alist
               '((lambda(bufname _)
                   (with-current-buffer bufname
                     (equal major-mode 'vterm-mode)))
                 (display-buffer-reuse-window display-buffer-at-bottom)
                 (reusable-frames . visible)
                 (window-height . 0.25)))
  :general (leader-def "t" 'vterm-toggle))
#+end_src

** CSV Mode
#+begin_src elisp
(use-package csv-mode
  :mode (("\\.csv$" . csv-mode))
  :straight t) 
#+end_src

** PDF Stuff
#+begin_src elisp
(use-package pdf-tools
  :straight (:host github :repo "vedang/pdf-tools"
             :branch "master")
  :mode (("\\.pdf$" . pdf-view-mode))
  :config
  (pdf-loader-install)
  (setq-default pdf-view-display-size 'fit-page)
  (setq pdf-annot-activate-created-annotati t))
#+end_src

** Tree-sitter
#+begin_src elisp
(use-package tree-sitter
  :straight t)
(use-package tree-sitter-langs
  :straight t)
#+end_src

** Code Folding
#+begin_src elisp
(use-package vimish-fold
  :defer t
  :straight t)
(use-package evil-vimish-fold
  :straight t
  :after '(vimish-fold evil)
  :hook ((prog-mode conf-mode text-mode) . evil-vimish-fold-mode))
(use-package hideshow
  :straight nil
  :hook ((prog-mode org-mode text-mode) . hs-minor-mode)
  :general
  (general-define-key 
    :keymaps 'normal
    "TAB" 'hs-toggle-hiding))
#+end_src

** Mu4e

#+begin_src elisp
(add-to-list 'exec-path "/usr/local/share/emacs/site-lisp/mu4e/")
(use-package mu4e
  :load-path "/usr/local/share/emacs/site-lisp/mu4e/"
  :straight nil
  :defer t
  :config
  (setq mu4e-change-filenames-when-moving t)
  ;; update every 3 minutes
  (setq mu4e-update-interval (* 3 60))
  (setq mu4e-get-mail-command "mbsync -a")
  ;; mail in the mail directory
  (setq mu4e-maildir-list (list "~/mail"))
  ;; set all the different folders
  (setq mu4e-drafts-folder "/[Gmail]/Drafts")
  (setq mu4e-sent-folder   "/[Gmail]/Sent Mail")
  (setq mu4e-refile-folder "/[Gmail]/All Mail")
  (setq mu4e-trash-folder  "/[Gmail]/Trash")
  ;; shortcuts
  (setq mu4e-maildir-shortcuts
        '(("/Inbox" . ?i)
          ("/[Gmail]/Sent Mail" . ?s)
          ("/[Gmail]/All Mail" . ?a)
          ("/[Gmail]/Trash" . ?t)
          ("/[Gmail]/Drafts" . ?d)))
  ;; read html better
  (setq mu4e-html2text-command "html2text"))

(use-package mu4e-alert
  :straight t
  :after mu4e
  :config 
  (mu4e-alert-set-default-style 'libnotify) 
  (setq mu4e-alert-email-notification-types '(count))
  (add-hook 'after-init-hook #'mu4e-alert-enable-notifications))

#+end_src

** ERC
#+begin_src elisp
(use-package erc
  :straight t)
#+end_src

* Editing
** Yasnippet
#+begin_src elisp
(use-package yasnippet
  :straight t
  :hook ((org-mode prog-mode) . yas-global-mode)
  :config
  (setq yas-verbosity 1 ; No need to be so verbose
        yas-wrap-around-region nil))
(use-package yasnippet-snippets
  :after yasnippet
  :straight t)
#+end_src

** Spelling
#+begin_src elisp
;; Ispell dicitonary
(setq ispell-dictionary "en")
(use-package wordnut
  :straight t
  :defer t
  :general 
  (leader-misc-def "k" 'wordnut-lookup-current-word ))
#+end_src

** Formatter
#+begin_src elisp
(use-package format-all
  :straight t
  :hook (prog-mode . format-all-mode)
  :general (leader-code-def "f" 'format-all-buffer)
  :init (add-hook 'prog-mode-hook 'format-all-ensure-formatter)
  :config
  (setq format-all-formatters (list '("haskell" . 'ormolu) '("python" . 'black) ))
  (setq bibtex-dialect 'biblatex
        bibtex-align-at-equal-sign t
        bibtex-text-indentation 20)
  )
#+end_src

* Almighty Org
** Org-stuff
#+begin_src elisp
;; don't care about any except bibtex really

(use-package org
  :mode (("\\.org$" . org-mode))
  :straight nil
  :hook
  (org-mode .  auto-fill-mode)
  (org-mode . (lambda () (electric-indent-local-mode -1)))
  :config
  ;; make ret follow links
  (setq org-return-follows-link t)
  (set-display-table-slot standard-display-table
              'selective-display (string-to-vector " ↷"))
  (setq org-startup-indented t
        org-confirm-babel-evaluate nil
        org-agenda-span 'week
        org-agenda-start-day "+0d"
        org-image-actual-width nil
        org-preview-latex-image-directory
    (concat nilays-cache-dir "ltximg/"))
  ;; org-mode src blocks
  (setq org-edit-src-content-indentation 0
        org-src-tab-acts-natively t)
  :general
  (leader-org-def "l" 'org-store-link)
  (leader-org-def "p" 'org-insert-link)
)
#+end_src

** Exporting
#+begin_src elisp
;; LaTeX Exporting
(use-package ox-latex
  :straight nil
  :config
  (setq org-latex-pdf-process
        (list "latexmk -outdir=./build/ -pdflatex='lualatex -shell-escape -interaction nonstopmode' -pdf -f  %f"))
  (setq org-beamer-frame-level 2)
  (setq org-startup-with-latex-preview nil)
  (setq org-latex-caption-above nil)
  (push '("homework" "\\documentclass{homework}") org-latex-classes))

#+end_src

** Superstar
#+begin_src elisp
;; Prettify
(use-package org-superstar
  :straight t
  :hook (org-mode . org-superstar-mode)
  :config
  (org-superstar-configure-like-org-bullets))
#+end_src

** Agenda
#+begin_src elisp
;; Agenda
(use-package org-agenda
  :straight nil
  :after org
  :general (leader-org-def "a" 'org-agenda)
  :config
  (setq org-agenda-files
    (directory-files-recursively "~/org/" "\\.org$"))
  (setq org-agenda-custom-commands
    '(("d" "Today's Tasks"
       ((agenda "" ((org-agenda-span 1)
            (org-agenda-overriding-header "Today's Tasks")))))))
  :custom
  (org-agenda-prefix-format '((agenda . " %i %-20:c%?-12t%-6e% s")
                  (todo   . " %i %-20:c %-6e")
                  (tags   . " %i %-20:c")
                  (search . " %i %-20:c"))))
#+end_src

** Roam
#+begin_src elisp
(use-package org-roam
  :straight t
  :hook (after-init . org-roam-mode)
  :custom (org-roam-directory "~/org/wiki/")
  :general
  (leader-org-roam-def 
    "l" 'org-roam
    "f" 'org-roam-find-file
    "g" 'org-roam-graph)
  (leader-org-roam-def
    "i" 'org-roam-insert
    "I" 'org-roam-insert-immediate))
#+end_src

* Prettifying
** Rougier
#+begin_src elisp
(use-package svg-tag-mode
  :straight
  (:type git
         :host github
         :repo "rougier/svg-tag-mode"
         :files ("svg-tag-mode.el"))
  :defer t)
#+end_src

** Set the frames and theme
#+begin_src elisp
;; load a theme
(use-package spacemacs-common
  :straight spacemacs-theme)
(use-package material-theme
  :straight t)
(use-package solarized-theme
  :straight t)
  
(setq default-frame-alist
      (append (list
               '(vertical-scroll-bars . nil)
               '(internal-border-width . 24)
               '(left-fringe    . 1)
               '(right-fringe   . 1)
               '(tool-bar-lines . 0)
               '(menu-bar-lines . 0))))

(defun nilays-set-display ()
  (interactive)
  ;; theme
  (setq modus-themes-slanted-constructs t
        modus-themes-bold-constructs t
        modus-themes-syntax 'faint
        modus-themes-mode-line nil)
  (load-theme 'solarized-gruvbox-dark t)
  ;; fonts
  (set-face-attribute
   'variable-pitch nil
   :font "Iosevka Medium Extended-13")
  (set-face-attribute
   'fixed-pitch nil
   :font "Iosevka Medium Extended-12")
  (set-face-attribute
   'default nil
   :font "Iosevka Medium Extended-12")
  )

(if (daemonp)
    (add-hook 'after-make-frame-functions
              (lambda (frame)
                (select-frame frame)
                (nilays-set-display)))
  (nilays-set-display))
#+end_src

** Visuals
#+begin_src elisp
;; turn off ugly stuff
(scroll-bar-mode -1)
(tool-bar-mode -1)
(menu-bar-mode -1)

(setq display-line-numbers-type 'relative)
(global-display-line-numbers-mode)
;; highlight current line
(global-hl-line-mode)

;; make lines wrap so no horizontal scrolling
(global-visual-line-mode)

;; highlight matching parentheses
(setq show-paren-delay 0)
(show-paren-mode)

;; disable the scratch message stuff
(setq initial-scratch-message nil)

;; max column width
(setq-default fill-column 100)

;; margins
(setq-default left-margin-width 1 right-margin-width 1)
#+end_src

** Modeline
#+begin_src elisp
(use-package doom-modeline
  :straight t
  :hook (after-init . doom-modeline-mode)
  :config
  (column-number-mode 1)
  (setq doom-modeline-height 32
        doom-modeline-bar-width 3
        doom-modeline-mu4e nil
        doom-modeline-buffer-file-name-style 'file-name
        doom-modline-percent-position nil
        doom-modeline-buffer-encoding nil))
;; (use-package spaceline
;;   :straight t
;;   :init
;;   (setq powerline-height 25
;;         powerline-default-separator 'wave
;;         spaceline-auto-compile-p nil) ;; don't autocompile
;;   (spaceline-spacemacs-theme)
;;   (spaceline-toggle-hud-off)
;;   (spaceline-toggle-mu4e-alert-segment-off)
;;   (spaceline-toggle-version-control-off)
;;   (spaceline-toggle-minor-modes-off))
#+end_src

** Highlight TODOs
#+begin_src elisp
(use-package hl-todo
  :straight t
  :hook (prog-mode . hl-todo-mode)
  :config
  (setq hl-todo-highlight-punctuation ":"
    hl-todo-keyword-faces `(("TODO" warning bold)
                ("FIXME" error bold)
                ("HACK" font-lock-constant-face bold)
                ("REVIEW" font-lock-keyword-face bold)
                ("NOTE" success bold)
                ("DEPRECATED" font-lock-doc-face bold))))
#+end_src
